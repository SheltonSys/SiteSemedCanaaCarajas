{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="content-wrapper" style="margin-left: 0; padding: 20px;">
    <div class="container-fluid">

        <!-- Cabe√ßalho -->
        <div class="text-center mb-4">
            <h1 class="display-4 text-primary font-weight-bold">Demonstrativo da Execu√ß√£o - PDDE</h1>
            <p class="text-muted">Registre e visualize receitas e despesas das escolas no programa PDDE.</p>
        </div>

        <!-- BLOCO 1 ‚Äì IDENTIFICA√á√ÉO -->
        <div class="card shadow-lg border-0">
            <div class="card-header bg-gradient-primary text-white">
                <h2 class="h5 mb-0"><i class="fas fa-school"></i> Identifica√ß√£o</h2>
            </div>
            <div class="card-body bg-light">
                <form method="POST" id="form-pdde-receita-despesa">
                    {% csrf_token %}
                    <div class="row">

                        <div class="col-md-6">
    <label for="escola-select" class="form-label">Selecionar Escola:</label>
    <select class="form-select" id="escola-select" name="escola" required>
        <option value="">-- Escolha a escola --</option>
        {% for escola in escolas %}
            <option value="{{ escola.id }}" {% if escolas|length == 1 %}selected data-unico="true"{% endif %}>{{ escola.nome }}</option>

        {% endfor %}
    </select>
</div>


                        <div class="col-md-6">
                            <label for="exercicio">Exerc√≠cio:</label>
                            <input type="text" id="exercicio" name="exercicio" class="form-control" value="2025" readonly>
                        </div>

                        <div class="col-md-6">
                            <label for="nome_conselho">Nome do Conselho:</label>
                            <input type="text" id="nome_conselho" name="nome_conselho" class="form-control" value="" readonly>
                        </div>

                        <div class="col-md-6">
                            <label for="cnpj">CNPJ:</label>
                            <input type="text" id="cnpj" name="cnpj" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="endereco">Endere√ßo:</label>
                            <input type="text" id="endereco" name="endereco" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="uf">UF:</label>
                            <input type="text" id="uf" name="uf" class="form-control" readonly>
                        </div>

                        <div class="col-md-12">
                            <label for="programas_vinculados">Programas Vinculados:</label>
                            <textarea id="programas_vinculados" name="programas_vinculados"
                                class="form-control bg-light text-dark fw-bold border-primary"
                                rows="3" readonly style="font-family: 'Courier New', Courier, monospace; line-height: 1.6; padding: 10px;">
                                {% for programa in programas_vinculados %}
                                    [{{ programa.nome }}]{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    Nenhum programa vinculado.
                                {% endfor %}
                            </textarea>
                        </div>


                        


                    </div>
                </form>
            </div>
        </div>

<!-- O restante do conte√∫do permanece igual -->




        <!-- BLOCO 2 ‚Äì RECEITAS E DESPESAS -->
        <!-- BLOCO 2 ‚Äì S√çNTESE DA EXECU√á√ÉO DA RECEITA E DA DESPESA -->
<div class="card shadow-lg border-0 mt-4">
    <div class="card-header bg-gradient-primary text-white">
        <h2 class="h5 mb-0"><i class="fas fa-file-invoice-dollar"></i> S√≠ntese da Execu√ß√£o da Receita e da Despesa</h2>
    </div>
    <div class="card-body bg-light">
        <div class="row">
            <!-- <div class="col-md-2">
                <label for="data_inicio">Data In√≠cio:</label>
                <input type="date" id="data_inicio" name="data_inicio" class="form-control"
    value="{{ receita.data_inicio|date:'Y-m-d'|default:'' }}" readonly>
            </div>
            <div class="col-md-2">
                <label for="data_fim">Data Fim:</label>
                <input type="date" id="data_fim" name="data_fim" class="form-control"
    value="{{ receita.data_fim|date:'Y-m-d'|default:'' }}" readonly>
            </div> -->

            <div class="col-md-3">
                <label for="saldo_anterior_custeio">01 ‚Äì Saldo Reprogramado EA (Custeio)</label>
                <input type="text" id="saldo_anterior_custeio" name="saldo_anterior_custeio"
                    class="form-control" value="{{ receita.saldo_anterior_custeio|default:"0.00" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="saldo_anterior_capital">01 ‚Äì Saldo Reprogramado EA (Capital)</label>
                <input type="text" id="saldo_anterior_capital" name="saldo_anterior_capital"
                    class="form-control" value="{{ receita.saldo_anterior_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="valor_creditado_custeio">02 ‚Äì Valor Creditado FNDE EE (Custeio)</label>
                <input type="text" id="valor_creditado_custeio" name="valor_creditado_custeio"
                    class="form-control" value="{{ receita.valor_creditado_custeio|default:"0.00" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="valor_creditado_capital">02 ‚Äì Valor Creditado FNDE EE (Capital)</label>
                <input type="text" id="valor_creditado_capital" name="valor_creditado_capital"
                    class="form-control" value="{{ receita.valor_creditado_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="recursos_proprios_custeio">03 ‚Äì Recursos Pr√≥prios (Custeio)</label>
                <input type="text" id="recursos_proprios_custeio" name="recursos_proprios_custeio"
                    class="form-control" value="{{ receita.recursos_proprios_custeio|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="recursos_proprios_capital">03 ‚Äì Recursos Pr√≥prios (Capital)</label>
                <input type="text" id="recursos_proprios_capital" name="recursos_proprios_capital"
                    class="form-control" value="{{ receita.recursos_proprios_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="rendimento_aplicacao_custeio">04 ‚Äì Rendimento Aplica√ß√£o (Custeio)</label>
                <input type="text" id="rendimento_aplicacao_custeio" name="rendimento_aplicacao_custeio"
                    class="form-control" value="{{ receita.rendimento_aplicacao_custeio|default:"0.00" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="rendimento_aplicacao_capital">04 ‚Äì Rendimento Aplica√ß√£o (Capital)</label>
                <input type="text" id="rendimento_aplicacao_capital" name="rendimento_aplicacao_capital"
                    class="form-control" value="{{ receita.rendimento_aplicacao_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="devolucao_fnde_custeio">05 ‚Äì Devolu√ß√£o FNDE (Custeio)</label>
                <input type="text" id="devolucao_fnde_custeio" name="devolucao_fnde_custeio"
                    class="form-control" value="{{ receita.devolucao_fnde_custeio|default:"0.00" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="devolucao_fnde_capital">05 ‚Äì Devolu√ß√£o FNDE (Capital)</label>
                <input type="text" id="devolucao_fnde_capital" name="devolucao_fnde_capital"
                    class="form-control" value="{{ receita.devolucao_fnde_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="valor_total_receita_custeio">06 ‚Äì Valor Total Receita (Custeio)</label>
                <input type="text" id="valor_total_receita_custeio" name="valor_total_receita_custeio"
                    class="form-control" value="{{ receita.valor_total_receita_custeio|default:"0.00" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="valor_total_receita_capital">06 ‚Äì Valor Total Receita (Capital)</label>
                <input type="text" id="valor_total_receita_capital" name="valor_total_receita_capital"
                    class="form-control" value="{{ receita.valor_total_receita_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="valor_despesa_realizada_custeio">07 ‚Äì Valor Despesa Realizada (-) (Custeio)</label>
                <input type="text" id="valor_despesa_realizada_custeio" name="valor_despesa_realizada_custeio"
                    class="form-control" value="{{ receita.valor_despesa_realizada_custeio|default:"0.00" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="valor_despesa_realizada_capital">07 ‚Äì Valor Despesa Realizada (-) (Capital)</label>
                <input type="text" id="valor_despesa_realizada_capital" name="valor_despesa_realizada_capital"
                    class="form-control" value="{{ receita.valor_despesa_realizada_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="saldo_reprogramar_custeio">08 ‚Äì Saldo Reprogramado ES (Custeio)</label>
                <input type="text" id="saldo_reprogramar_custeio" name="saldo_reprogramar_custeio"
                    class="form-control" value="{{ receita.saldo_reprogramar_custeio|default:"0.00" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="saldo_reprogramar_capital">08 ‚Äì Saldo Reprogramado ES (Capital)</label>
                <input type="text" id="saldo_reprogramar_capital" name="saldo_reprogramar_capital"
                    class="form-control" value="{{ receita.saldo_reprogramar_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="saldo_devolvido_custeio">09 ‚Äì Saldo Devolvido (Custeio)</label>
                <input type="text" id="saldo_devolvido_custeio" name="saldo_devolvido_custeio"
                    class="form-control" value="{{ receita.saldo_devolvido_custeio|default:"0.00" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="saldo_devolvido_capital">09 ‚Äì Saldo Devolvido (Capital)</label>
                <input type="text" id="saldo_devolvido_capital" name="saldo_devolvido_capital"
                    class="form-control" value="{{ receita.saldo_devolvido_capital|default:"0.00" }}" readonly>
            </div>

            <div class="col-md-3">
                <label for="escolas_atendidas">10 ‚Äì N¬∫ Escolas Atendidas</label>
                <input type="text" id="escolas_atendidas" name="escolas_atendidas"
                    class="form-control" value="{{ receita.escolas_atendidas|default:"1" }}" readonly>
            </div>
            

            <!-- <div class="col-md-3">
                <label for="receita_custeio_capital">19 ‚Äì Receita (Custeio e Capital)</label>
                <input type="text" id="receita_custeio_capital" name="receita_custeio_capital"
                    class="form-control" value="{{ receita.escolas_atendidas|default:"0" }}" readonly>
            </div>
            <div class="col-md-3">
                <label for="despesa_custeio_capital">20 ‚Äì Despesa (Custeio e Capital)</label>
                <input type="text" id="despesa_custeio_capital" name="despesa_custeio_capital"
                    class="form-control" value="{{ receita.escolas_atendidas|default:"0" }}" readonly>
            </div> -->
        </div>
    </div>
</div>



<div class="col-md-6 d-flex align-items-center">
    <small class="form-text fw-bold text-primary bg-light p-2 rounded border">
        <span class="text-dark"><strong>EA</strong></span> = Exerc√≠cio Anterior &nbsp; | &nbsp;
        <span class="text-dark"><strong>EE</strong></span> = Em Exerc√≠cio &nbsp; | &nbsp;
        <span class="text-dark"><strong>ES</strong></span> = Exerc√≠cio Seguinte
    </small>
</div>


        
        


       <!-- BLOCO 3 ‚Äì PAGAMENTOS EFETUADOS -->
       <div class="card shadow-lg border-0 mt-4">
        <div class="card-header bg-gradient-primary text-white">
            <h2 class="h5 mb-0"><i class="fas fa-money-check-alt"></i> Pagamentos Efetuados</h2>
        </div>
        <div class="card-body bg-light">
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="bg-primary text-white">
                        <tr>
                            <th>#</th>
                            <th>Nome do Favorecido</th>
                            <th>CNPJ/CPF</th>
                            <th>Tipo de Bens e Materiais/Servi√ßos</th>
                            <th>Origem</th>
                            <th>Nat. Despesa</th>
                            <th>Documento<br><small>Tipo</small></th>
                            <th>Documento<br><small>N¬∫</small></th>
                            <th>Documento<br><small>Data</small></th>
                            <th>Pagamento<br><small>N¬∫ Ch/OB</small></th>
                            <th>Pagamento<br><small>Data</small></th>
                            <th>Valor (R$)</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
    
                    <tbody id="tabela-pagamentos">
                        {% for pagamento in pagamentos %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="text-start">{{ pagamento.nome_favorecido }}</td>
                            <td>{{ pagamento.cnpj_cpf }}</td>
                            <td class="text-start">{{ pagamento.tipo_bem_servico }}</td>
                            <td>{% if pagamento.origem %}{{ pagamento.origem }}{% else %}FNDE{% endif %}</td>
                            <td>{{ pagamento.tipo_pagamento }}</td>
                            <td>{{ pagamento.tipo_documento }}</td>
                            <td>{{ pagamento.numero_documento }}</td>
                            <td>{{ pagamento.data_documento|date:"d/m/Y" }}</td>
                            <td>{{ pagamento.numero_pagamento }}</td>
                            <td>{{ pagamento.data_pagamento|date:"d/m/Y" }}</td>
                            <td class="valor-pagamento {% if pagamento.tipo_pagamento == 'Custeio' %}custeio{% else %}capital{% endif %}">
                                R$ {{ pagamento.valor|floatformat:2|stringformat:".2f"|default:"0,00" }}
                            </td>
                            <td>
                                <a href="{% url 'editar_pagamento' pagamento.id %}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="13" class="text-center text-muted">Nenhum pagamento registrado ainda.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
    
                    <!-- Rodap√© com totais -->
                    <tfoot class="border-top">
                        <tr class="bg-light fw-bold">
                            <td colspan="10" class="text-end pe-3 py-2">
                                <i class="fas fa-coins text-primary me-2"></i> Total Custeio:
                            </td>
                            <td id="total-custeio" class="text-primary fw-bold py-2" colspan="2">R$ 0,00</td>
                            <td></td>
                        </tr>
                        <tr class="bg-light fw-bold">
                            <td colspan="10" class="text-end pe-3 py-2">
                                <i class="fas fa-piggy-bank text-success me-2"></i> Total Capital:
                            </td>
                            <td id="total-capital" class="text-success fw-bold py-2" colspan="2">R$ 0,00</td>
                            <td></td>
                        </tr>
                        <tr class="bg-gradient-secondary text-white fw-bold">
                            <td colspan="10" class="text-end pe-3 py-2">
                                <i class="fas fa-hand-holding-usd text-warning me-2"></i> Total Pagamentos:
                            </td>
                            <td id="total-geral" colspan="2" class="text-warning fw-bold py-2">R$ 0,00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                    


                </table>
            </div>
        </div>
    </div>
    



        <!-- BLOCO 4 ‚Äì AUTENTICA√á√ÉO -->
        <div class="card shadow-lg border-0 mt-4">
            <div class="card-header bg-gradient-primary text-white">
                <h2 class="h5 mb-0"><i class="fas fa-user-check"></i> Autentica√ß√£o</h2>
            </div>
            <div class="card-body bg-light">
                <div class="row">
                    {% load tz %}
                        {% now "d \d\e F \d\e Y" as data_atual %}
                        <div class="col-md-6">
                            <label for="local_data">Local e Data:</label>
                            <input type="text" id="local_data" name="local_data" class="form-control"
                                value="Cana√£ dos Caraj√°s (PA), {{ data_atual }}" readonly>
                        </div>

                    <div class="col-md-6">
    <label for="dirigente" class="form-label">Nome do Dirigente:</label>
    <input type="text" id="dirigente" name="dirigente" class="form-control" readonly>
</div>




                </div>
            </div>
        </div>

        <!-- Bot√µes -->
        <!-- Bot√µes -->
        <div class="text-end mt-4">
            <!-- <button type="submit" class="btn btn-primary shadow-sm">
                <i class="fas fa-save"></i> Salvar
            </button> -->
            
            <a href="{% url 'pdde_gerar_pdf' %}?escola_id={{ escola.id }}" 
            class="btn btn-danger shadow-sm" 
            target="_blank">
                <i class="fas fa-file-pdf"></i> Gerar Relat√≥rio PDF
            </a>


            <a href="{% url 'pdde' %}" class="btn btn-secondary shadow-sm">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>


    </div>
</div>

<br>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        const escolaSelect = document.getElementById("escola-select");
        const programaSelect = document.getElementById("programa-select");
        const tabelaPagamentos = document.getElementById("tabela-pagamentos");

        // üîπ Elementos de totaliza√ß√£o
        const totalCusteio = document.getElementById("total-custeio");
        const totalCapital = document.getElementById("total-capital");
        const totalGeral = document.getElementById("total-geral");

        // üîπ Evento ao selecionar uma escola
        escolaSelect.addEventListener("change", function () {
            let escolaId = this.value;
            if (!escolaId) return;

            // Buscar dados da escola
            fetch(`/get-escola-pdde/${escolaId}/`)
                .then(response => response.json())
                .then(data => {
                    ["nome_conselho", "cnpj", "endereco", "municipio", "uf"].forEach(campo => {
                        let elemento = document.getElementById(campo);
                        if (elemento) elemento.value = data[campo] || "N√£o informado";
                    });
                })
                .catch(error => console.error("‚ùå Erro ao buscar os dados da escola:", error));

            // Buscar receitas e despesas
            fetch(`/get-receita-despesa/${escolaId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.erro) return console.error("‚ùå Erro ao carregar receitas e despesas:", data.erro);

                    [
                        "saldo_anterior_custeio", "saldo_anterior_capital",
                        "valor_creditado_custeio", "valor_creditado_capital",
                        "recursos_proprios_custeio", "recursos_proprios_capital",
                        "rendimento_aplicacao_custeio", "rendimento_aplicacao_capital",
                        "devolucao_fnde_custeio", "devolucao_fnde_capital",
                        "saldo_devolvido_custeio", "saldo_devolvido_capital",
                        "valor_total_receita_custeio", "valor_total_receita_capital",
                        "valor_despesa_realizada_custeio", "valor_despesa_realizada_capital",
                        "saldo_reprogramar_custeio", "saldo_reprogramar_capital"
                    ].forEach(campo => {
                        let campoElement = document.getElementById(campo);
                        if (campoElement) {
                            campoElement.value = data[campo] ? formatarValor(data[campo]) : "0,00";
                        }
                    });

                    let periodoElement = document.getElementById("periodo_execucao");
                    if (periodoElement) {
                        periodoElement.value = `${data.data_inicio || "N√£o informado"} at√© ${data.data_fim || "N√£o informado"}`;
                    }
                })
                .catch(error => console.error("‚ùå Erro ao buscar os dados financeiros:", error));

            // Buscar programas vinculados
            fetch(`/get-programas-vinculados/${escolaId}/`)
                .then(response => response.json())
                .then(data => {
                    let programasTextarea = document.getElementById("programas_vinculados");
                    if (programasTextarea) {
                        programasTextarea.value = data.programas.length > 0 ? data.programas.join(", ") : "Nenhum programa vinculado";
                    }
                })
                .catch(error => console.error("‚ùå Erro ao buscar os programas vinculados:", error));

            // Buscar pagamentos
            carregarPagamentos(escolaId);
        });

        function carregarPagamentos(escolaId) {
            if (!escolaId) return;
            fetch(`/get-pagamentos/${escolaId}/`)
                .then(response => response.json())
                .then(data => {
                    tabelaPagamentos.innerHTML = "";
                    let totalCusteioVal = 0;
                    let totalCapitalVal = 0;

                    if (data.pagamentos && data.pagamentos.length > 0) {
                        data.pagamentos.forEach((pagamento, index) => {
                            let valor = parseFloat(pagamento.valor) || 0;
                            if (pagamento.tipo_pagamento === "Custeio") totalCusteioVal += valor;
                            else totalCapitalVal += valor;

                            let row = `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td class="text-start">${pagamento.nome_favorecido || "N√£o informado"}</td>
                                    <td>${pagamento.cnpj_cpf || "N/A"}</td>
                                    <td class="text-start">${pagamento.tipo_bem_servico || "N/A"}</td>
                                    <td>${pagamento.origem || "FNDE"}</td>
                                    <td>${pagamento.tipo_pagamento || "N/A"}</td>
                                    <td>${pagamento.tipo_documento || ""}</td>
                                    <td>${pagamento.numero_documento || ""}</td>
                                    <td>${pagamento.data_documento || ""}</td>
                                    <td>${pagamento.numero_pagamento || ""}</td>
                                    <td>${pagamento.data_pagamento || ""}</td>
                                    <td class="valor-pagamento ${pagamento.tipo_pagamento === 'Custeio' ? 'custeio' : 'capital'}">
                                        R$ ${formatarValor(valor)}
                                    </td>
                                    <td>
                                        <a href="${pagamento.url_editar}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                    </td>
                                </tr>`;
                            tabelaPagamentos.innerHTML += row;
                        });
                    } else {
                        tabelaPagamentos.innerHTML = `
                            <tr>
                                <td colspan="13" class="text-center text-muted">Nenhum pagamento registrado ainda.</td>
                            </tr>`;
                    }

                    atualizarTotais(totalCusteioVal, totalCapitalVal);
                })
                .catch(error => console.error("‚ùå Erro ao carregar pagamentos:", error));
        }

        function atualizarTotais(custeio, capital) {
            let total = custeio + capital;
            totalCusteio.textContent = `R$ ${formatarValor(custeio)}`;
            totalCapital.textContent = `R$ ${formatarValor(capital)}`;
            totalGeral.textContent = `R$ ${formatarValor(total)}`;
        }

        function formatarValor(valor) {
            return parseFloat(valor || 0).toLocaleString("pt-BR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // üîπ Ap√≥s tudo carregado, se s√≥ houver uma escola, dispare o evento de sele√ß√£o
        const unica = escolaSelect.querySelector('option[selected][data-unico="true"]');
        if (unica) {
            escolaSelect.value = unica.value;
            escolaSelect.dispatchEvent(new Event("change"));
        }
    });
</script>



<script>
    function atualizarCamposReceita(escolaId) {
        if (!escolaId) return;

        fetch(`/get-receita-despesa/${escolaId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.erro) return console.error("‚ùå Erro ao carregar receita:", data.erro);

                document.getElementById("valor_despesa_realizada_custeio").value = formatarValor(data.valor_despesa_realizada_custeio || 0);
                document.getElementById("valor_despesa_realizada_capital").value = formatarValor(data.valor_despesa_realizada_capital || 0);
                document.getElementById("saldo_reprogramar_custeio").value = formatarValor(data.saldo_reprogramar_custeio || 0);
                document.getElementById("saldo_reprogramar_capital").value = formatarValor(data.saldo_reprogramar_capital || 0);
            })
            .catch(error => console.error("‚ùå Erro ao atualizar os valores da receita:", error));
    }

    function formatarValor(valor) {
        return parseFloat(valor).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Chama a fun√ß√£o ap√≥s cada pagamento salvo
    document.addEventListener("DOMContentLoaded", function () {
        let escolaId = document.getElementById("escola-select").value;
        if (escolaId) {
            atualizarCamposReceita(escolaId);
        }
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const escolaSelect = document.getElementById("escola-select");
        const totalCusteio = document.getElementById("total-custeio");
        const totalCapital = document.getElementById("total-capital");
        const totalGeral = document.getElementById("total-geral");
        const tabelaPagamentos = document.getElementById("tabela-pagamentos");

        function formatarValor(valor) {
            return parseFloat(valor || 0).toLocaleString("pt-BR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function atualizarTotais(custeio, capital) {
            let total = custeio + capital;
            totalCusteio.textContent = `R$ ${formatarValor(custeio)}`;
            totalCapital.textContent = `R$ ${formatarValor(capital)}`;
            totalGeral.textContent = `R$ ${formatarValor(total)}`;
        }

        function carregarPagamentos(escolaId) {
            fetch(`/get-pagamentos/${escolaId}/`)
                .then(res => res.json())
                .then(data => {
                    let totalCusteioVal = 0;
                    let totalCapitalVal = 0;
                    tabelaPagamentos.innerHTML = "";

                    if (data.pagamentos && data.pagamentos.length > 0) {
                        data.pagamentos.forEach((p, i) => {
                            const valor = parseFloat(p.valor) || 0;
                            if (p.tipo_pagamento === "Custeio") totalCusteioVal += valor;
                            else totalCapitalVal += valor;

                            tabelaPagamentos.innerHTML += `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td class="text-start">${p.nome_favorecido || "-"}</td>
                                    <td>${p.cnpj_cpf || "-"}</td>
                                    <td class="text-start">${p.tipo_bem_servico || "-"}</td>
                                    <td>${p.origem || "FNDE"}</td>
                                    <td>${p.tipo_pagamento || "-"}</td>
                                    <td>${p.tipo_documento || "-"}</td>
                                    <td>${p.numero_documento || "-"}</td>
                                    <td>${p.data_documento || "-"}</td>
                                    <td>${p.numero_pagamento || "-"}</td>
                                    <td>${p.data_pagamento || "-"}</td>
                                    <td class="valor-pagamento ${p.tipo_pagamento === 'Custeio' ? 'custeio' : 'capital'}">R$ ${formatarValor(valor)}</td>
                                    <td><a href="${p.url_editar}" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i> Editar</a></td>
                                </tr>
                            `;
                        });
                    } else {
                        tabelaPagamentos.innerHTML = `
                            <tr>
                                <td colspan="13" class="text-center text-muted">Nenhum pagamento registrado ainda.</td>
                            </tr>
                        `;
                    }

                    atualizarTotais(totalCusteioVal, totalCapitalVal);
                })
                .catch(err => console.error("Erro ao carregar pagamentos:", err));
        }

        function atualizarCamposReceita(escolaId) {
            fetch(`/get-receita-despesa/${escolaId}/`)
                .then(res => res.json())
                .then(data => {
                    [
                        "valor_despesa_realizada_custeio",
                        "valor_despesa_realizada_capital",
                        "saldo_reprogramar_custeio",
                        "saldo_reprogramar_capital"
                    ].forEach(id => {
                        let el = document.getElementById(id);
                        if (el) el.value = formatarValor(data[id] || 0);
                    });
                });
        }

        function carregarDadosEscola(escolaId) {
            fetch(`/get-escola-pdde/${escolaId}/`)
                .then(res => res.json())
                .then(data => {
                    ["nome_conselho", "cnpj", "endereco", "uf"].forEach(campo => {
                        let el = document.getElementById(campo);
                        if (el) el.value = data[campo] || "N√£o informado";
                    });
                });
        }

        function carregarProgramasVinculados(escolaId) {
        fetch(`/get-programas-vinculados/${escolaId}/`)
            .then(res => res.json())
            .then(data => {
                let el = document.getElementById("programas_vinculados");
                if (el) {
                    if (data.programas.length > 0) {
                        const texto = data.programas.map(p => `[${p}]`).join(", ");
                        el.value = texto;
                    } else {
                        el.value = "Nenhum programa vinculado";
                    }
                }
            })
            .catch(err => {
                console.error("Erro ao carregar programas vinculados:", err);
            });
    }


        // Quando muda a escola manualmente
        escolaSelect.addEventListener("change", () => {
            let escolaId = escolaSelect.value;
            if (escolaId) {
                carregarDadosEscola(escolaId);
                carregarProgramasVinculados(escolaId);
                carregarPagamentos(escolaId);
                atualizarCamposReceita(escolaId);
            }
        });

        // Carregamento inicial
        const escolaIdInicial = escolaSelect.value;
        if (escolaIdInicial) {
            carregarDadosEscola(escolaIdInicial);
            carregarProgramasVinculados(escolaIdInicial);
            carregarPagamentos(escolaIdInicial);
            atualizarCamposReceita(escolaIdInicial);
        }
    });
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const escolaSelect = document.getElementById("escola-select");  // Corrigido aqui
    const dirigenteInput = document.getElementById("dirigente");

    if (escolaSelect && dirigenteInput) {
        escolaSelect.addEventListener("change", function () {
            const escolaId = this.value;

            if (!escolaId) {
                dirigenteInput.value = "";
                return;
            }

            fetch(`/ajax/get-dirigente/${escolaId}/`)
                .then(response => response.json())
                .then(data => {
                    dirigenteInput.value = data.nome_dirigente || "N√£o encontrado";
                })
                .catch(error => {
                    console.error("Erro ao buscar dirigente:", error);
                    dirigenteInput.value = "Erro";
                });
        });

        // Autopreencher se s√≥ houver uma escola
        if (escolaSelect.dataset.unico === "true" || escolaSelect.querySelector("option[data-unico='true']")) {
            escolaSelect.dispatchEvent(new Event('change'));
        }
    }
});
</script>








{% endblock %}